#Local code moderm(list = ls())gc()sensitivity_mode <- 0# gpuMode <- 0# library(gpuR)#-------------------------------#Data End----#the last year of the recorded dataRealYear <- 2019#the last year of forcastendYear <- 2020#START-----#Reading lib and csv datasource("global.R")#Set CompoundCmp_choose_ID <- c(21:29)#if run in single mode: Cmp_choose_ID <- 1Process_Worker <- cbind.data.frame(Cmp_ID = Cmp_choose_ID)#if run in step mode: Cmp_ID <- 1Pr_worker <- function(x) {    Cmp_ID <<- as.numeric(x)  print(paste0("Caculate compound ID ",Cmp_ID))  #Loading Data  source("Value list.R")    #Caculate intermedia  source("intermedia.R")    #Caculate D value matrix  source("D_Value.R")    #Solve PDE Equation  source("PDE.R")  # if (exists("Bimontyly_Flux_ALL")) {  #   Bimontyly_Flux_ALL <<- rbind.data.frame(Bimontyly_Flux_ALL, fluxes_bimonthly)  # } else {  #   Bimontyly_Flux_ALL <<- fluxes_bimonthly  # }  return(list(Conc=Bimonthly_Conc_Range,              flux=fluxes_bimonthly,              Bulk_fugacity=Bimonthly_f_mean,              Intm_time_export=Intm_time_mean,              D_TS_export=D_TS_mean))  }#if run in R parallel mode#prepare parallel env#library(parallel)clnum<- 10# detectCores() cl <- makeCluster(getOption("cl.cores", clnum))all_list <- ls()clusterExport(cl, all_list, envir=environment())clusterEvalQ(cl, c(library("data.table"),library("magrittr"),library("deSolve")))#run in parallel#[[]][1] Conc #[[]][2]fluxBimonthly_List_ALL <- parLapply(cl,Cmp_choose_ID,Pr_worker) #spilt resultsBimonthly_Conc_ALL <- rbindlist(lapply(Bimonthly_List_ALL,function(x) x$Conc),                                 use.names=TRUE, fill=TRUE)Bimontyly_Flux_ALL <- rbindlist(lapply(Bimonthly_List_ALL,function(x) x$flux),                                 use.names=TRUE, fill=TRUE)#if run in debug step mode#Bimonthly_Conc_ALL <- Bimonthly_Conc_Range#if not normal mode# Bimonthly_Conc_ALL <- apply(Process_Worker,1,Pr_worker) %>% #   rbindlist(., use.names=TRUE, fill=TRUE)#Export Results to CSV#change bimonthly count number to YYYY-MM-01 / YYYY-MM-16 format#However YYYY-MM-01 means data from day 01 to day 15 in this monthfunc_data_formart <- function(x){  x <- x["bimonthly"] %>% as.numeric()  if ((x%%2) == 0){    yyyy <- floor(x/24) + Yr_start    mm_dd <- paste0((x%%24)/2,"-16")    if ((x%%24)/2 == 0){      mm_dd<- "12-16"      yyyy <- yyyy - 1}  }else{    yyyy <- floor(x/24) + Yr_start    mm_dd <- paste0((x%%24)/2+0.5,"-1")  }  return(paste0(yyyy,"-",mm_dd))}Bimonthly_Conc_ALL$bimonthly <- apply(Bimonthly_Conc_ALL,1,func_data_formart)Bimontyly_Flux_ALL$bimonthly <- apply(Bimontyly_Flux_ALL,1,func_data_formart)#fwrite(Bimonthly_Conc_ALL,"Bimonthly_Conc_ALL.csv")#fwrite(Bimontyly_Flux_ALL,"Bimontyly_Flux_ALL.csv")#PROCESS UNIT#mol/m3 to ng/mL(ppb)#ng/ml = mol/m3 * molmass * 1000Bimonthly_Conc_in_ngmL <- cbind.data.frame(Bimonthly_Conc_ALL[,1:2],                                           Bimonthly_Conc_ALL[,3:ncol(Bimonthly_Conc_ALL)]*                                             unlist(DB_Comp[Bimonthly_Conc_ALL$Comp_ID, "molmass",                                                            with = FALSE])*                                             1000) %>% as.data.table()#Unit for fluxes: g/d= = mol/d * molmass Bimontyly_Flux_in_ngmL <- cbind.data.frame(Bimontyly_Flux_ALL[,1:3],                                           Bimontyly_Flux_ALL[,4:ncol(Bimontyly_Flux_ALL)]*                                             unlist(DB_Comp[Bimontyly_Flux_ALL$Comp_ID, "molmass",                                                            with = FALSE])                                            ) %>% as.data.table()Bimonthly_Conc_in_ngmL$bimonthly <- as.Date(Bimonthly_Conc_in_ngmL$bimonthly,'%Y-%m-%d')Bimonthly_Conc_in_ngmL <- Bimonthly_Conc_in_ngmL[bimonthly>= as.Date("2011-01-01"),]Bimontyly_Flux_in_ngmL$bimonthly <- as.Date(Bimontyly_Flux_in_ngmL$bimonthly,'%Y-%m-%d')Bimontyly_Flux_in_ngmL <- Bimontyly_Flux_in_ngmL[bimonthly>= as.Date("2011-01-01"),]#Additional export for Fugacity 12/23/2020Bulk_fugacity_All <-rbindlist(lapply(Bimonthly_List_ALL,function(x) x$Bulk_fugacity),                          use.names=TRUE, fill=TRUE)Bulk_fugacity_All$bimonthly <- apply(Bulk_fugacity_All,1,func_data_formart)Bulk_fugacity_All <- Bulk_fugacity_All[bimonthly>= as.Date("2011-01-01"),]#Additional export for Intm_time_exp 12/24/2020Intm_time_All <-  rbindlist(lapply(Bimonthly_List_ALL,function(x) x$Intm_time_export),                             use.names=TRUE, fill=TRUE)Intm_time_All$bimonthly <- apply(Intm_time_All,1,func_data_formart)Intm_time_All <- Intm_time_All[bimonthly>= as.Date("2011-01-01"),]#Additional export for D_TSD_TS_All <-  rbindlist(lapply(Bimonthly_List_ALL,function(x) x$D_TS_export),                             use.names=TRUE, fill=TRUE)D_TS_All$bimonthly <- apply(D_TS_All,1,func_data_formart)D_TS_All <- D_TS_All[bimonthly>= as.Date("2011-01-01"),]#write to CSV#fwrite(Bimonthly_Conc_in_ngmL,"Bimonthly_Conc_in_ngmL_PFAS.csv")#fwrite(Bimontyly_Flux_in_ngmL,"Bimontyly_Flux_in_ngmL.csv")#fwrite(Bulk_fugacity_All,"Bulk_fugacity.csv")#fwrite(Intm_time_All,"Intm_time.csv")#fwrite(D_TS_All,"D_TS.csv")stopCluster(cl)#save(Bimonthly_Conc_in_ngmL,file='Bimonthly_Conc_in_ngmL.Rdata')#--#ngmLyear2020 <- Bimonthly_Conc_in_ngmL[year(bimonthly)==2020]mean_value_2020 <- year2020[, lapply(.SD, mean), by = Comp_ID]fwrite(mean_value_2020,"mean_value_2020_original_bio_idealbyref.csv")